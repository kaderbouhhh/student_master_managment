{% extends 'attendance/dashboard.html' %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center p-3 mb-5 mt-1 border-bottom">
    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø·Ù€Ù€Ù„Ø§Ø¨</h3>
    <div class="d-flex justify-content-start">
        <button type="button" class="btn btn-success dash_butt" data-toggle="modal" data-target="#addStudentContratModal">
            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
        <button type="button" class="btn btn-primary dash_butt me-1" data-toggle="modal" data-target="#importCSVModal">
            <i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† CSV
        </button>
    </div>
</div>

<div class="table-responsive" style="font-size: 0.8rem;">
    <table id="contratTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
        <thead>
            <tr class="bg-dark text-light text-center">
                <th class="text-center text-light">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="text-center text-light">Ø§Ù„Ù„Ù‚Ø¨</th>
                <th class="text-center text-light">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th class="text-center text-light">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                <th class="text-center text-light">Ù…ÙƒØ§Ù† Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                <th class="text-center text-light">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th>
                <th class="text-right text-light">
                    <input type="checkbox" id="checkAll" style="margin: 0 23px 0 0;"> <!-- Check All Checkbox --> 
                    <button id="sendEmailBtn" class="btn btn-primary tex-left py-1">
                       <i class="fa fa-envelope"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                    </button>
                </th>
            </tr>
        </thead>
        <tbody id="contratTableBody">
            {% for contrat in contrats %}
                {% include 'dashboard/partials/student_contrat_row.html' %}
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <!-- Button to Send Emails -->

</div>


{% include 'dashboard/modals/student_contrat_modals.html' %}

<!-- Modal for CSV Upload -->
<div class="modal fade" id="importCSVModal" tabindex="-1" role="dialog" aria-labelledby="importCSVModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="importCSVForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù CSV</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="file" name="csv_file" id="csv_file" accept=".csv, .xlsx" class="form-control" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
    $(document).ready(function () {
        let contratTable = $('#contratTable').DataTable({
            responsive: true,
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.5/i18n/ar.json",
            },
        });

        function refreshContratList() {
            $.ajax({
                url: "{% url 'student_contrat_list' %}",
                type: "GET",
                success: function (response) {
                    $('#contratTableBody').html($(response).find('#contratTableBody').html());
                    contratTable.destroy();
                    contratTable = $('#contratTable').DataTable({
                        responsive: true,
                        language: {
                            url: "https://cdn.datatables.net/plug-ins/1.13.5/i18n/ar.json",
                        },
                    });
                },
                error: function () {
                    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯.");
                },
            });
        }

    // Add Student Contract
    $("#addStudentContratForm").on("submit", function (e) {
        e.preventDefault();
        let form = $(this);
        let submitButton = form.find("button[type='submit']");
        submitButton.prop("disabled", true);

        $.ajax({
            type: "POST",
            url: form.attr("action"),
            data: form.serialize(),
            success: function (response) {
                if (response.status === "success") {
                    $("#addStudentContratModal").modal("hide");
                    $("#contratTableBody").append(response.new_contrat_row);
                    form[0].reset();
                } else {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯.");
                }
            },
            error: function (response) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©:", response);
            },
            complete: function () {
                submitButton.prop("disabled", false);
            }
        });
    });
   
       
  // âœ… Show Edit Modal and Load Data
$("#editStudentContratModal").on("show.bs.modal", function (event) {
    let button = $(event.relatedTarget);
    let contratId = button.data("id");  
    let form = $("#editStudentContratForm");

    form.attr("action", `/contrats/edit/${contratId}/`);  // âœ… Correct URL
    form.find("#editStudentContratId").val(contratId);

    // âœ… Populate Fields
    form.find("#editStudentContratFirstName").val(button.data("first-name"));
    form.find("#editStudentContratLastName").val(button.data("last-name"));
    form.find("#editStudentContratFirstNameEn").val(button.data("first-name-en"));
    form.find("#editStudentContratLastNameEn").val(button.data("last-name-en"));
    form.find("#editStudentContratBirthDay").val(button.data("birth-day"));
    form.find("#editStudentContratBirthPlace").val(button.data("birth-place"));
    form.find("#editStudentContratBirthWilaya").val(button.data("birth-wilaya"));
    form.find("#editStudentContratLiveWilaya").val(button.data("live-wilaya"));
    form.find("#editStudentContratEmail").val(button.data("email"));
    form.find("#editStudentContratAddress").val(button.data("address"));

    // âœ… Populate Select Fields
    form.find("#editStudentContratBranch").val(button.data("branch")).change();
    form.find("#editStudentContratCategory").val(button.data("category")).change();
    form.find("#editStudentContratSexe").val(button.data("sexe")).change();
    form.find("#editStudentContratAcademicYear").val(button.data("academic-year")).change();
});

// âœ… Handle Edit Form Submission
$("#editStudentContratForm").on("submit", function (e) {
    e.preventDefault();
    let form = $(this);
    let submitButton = form.find("button[type='submit']");
    submitButton.prop("disabled", true);

    $.ajax({
        type: "POST",
        url: form.attr("action"),
        data: form.serialize(),
        success: function (response) {
            if (response.status === "success") {
                $("#editStudentContratModal").modal("hide");
                $(`#contrat-${response.contrat_id}`).replaceWith(response.updated_row);
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!");
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                console.error("Validation Errors:", response.errors);  
            }
        },
        error: function (xhr) {
            console.error("ğŸš¨ AJAX Error:", xhr.responseText);
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
        },
        complete: function () {
            submitButton.prop("disabled", false);
        }
    });
});


        // âœ… Show Delete Confirmation Modal and Set Action
        $(document).on("click", ".delete-student-btn", function () {
            let contratId = $(this).data("id");
            $("#deleteStudentContratForm").attr("action", `/contrats/delete/${contratId}/`);
            $("#deleteStudentContratId").val(contratId);
        });
    
        // âœ… Handle Delete Form Submission
        $("#deleteStudentContratForm").on("submit", function (e) {
            e.preventDefault();
            let form = $(this);
            let csrfToken = $("input[name='csrfmiddlewaretoken']").val();
    
            $.ajax({
                type: "POST",
                url: form.attr("action"),
                headers: { "X-CSRFToken": csrfToken },
                success: function (response) {
                    if (response.status === "success") {
                        $("#deleteStudentContratModal").modal("hide");  // Close modal
                        $(`#contrat-${response.contrat_id}`).fadeOut("slow", function () {
                            $(this).remove();  // Remove row from table
                        });
                        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!");
                    } else {
                        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯.");
                    }
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯.");
                }
            });
        });
    
        // âœ… Refresh Contracts List After Editing/Deleting
        function refreshContratList() {
            $.ajax({
                url: "{% url 'student_contrat_list' %}",
                type: "GET",
                success: function (response) {
                    $("#contratTableBody").html($(response).find("#contratTableBody").html());
                },
                error: function () {
                    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");
                }
            });
        }
    
        // Check All functionality
        $("#checkAll").click(function () {
            $(".contrat-checkbox").prop("checked", this.checked);
        });

        // Handle Send Email Button Click
        $("#sendEmailBtn").click(function () {
            let selectedContracts = [];
            $(".contrat-checkbox:checked").each(function () {
                selectedContracts.push($(this).val());
            });

            if (selectedContracts.length === 0) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚ÙˆØ¯ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
                return;
            }

            // Send the selected contracts to the server
            $.ajax({
                url: "{% url 'send_contracts_email' %}", // Backend view to handle emails
                type: "POST",
                data: {
                    contracts: JSON.stringify(selectedContracts),
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                },
                success: function (response) {
                    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯.");
                },
            });
        });

        $("#importCSVForm").on("submit", function (e) {
            e.preventDefault();
            let formData = new FormData();
            let fileInput = $("#csv_file")[0].files[0];
            if (!fileInput) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ù„Ø±ÙØ¹.");
                return;
            }

            formData.append("csv_file", fileInput);
            formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

            $.ajax({
                url: "{% url 'import_student_contrats' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    alert(response.message);
                    location.reload();  // Reload page to show new data
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                },
            });
        });
        
    });
</script>

{% endblock %}
